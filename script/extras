#!/bin/bash

set -e

echo "=== Dev Environment Bootstrap ==="
echo

# Install Claude Code if not installed
if ! command -v claude &> /dev/null; then
    echo "Installing Claude Code..."
    curl -fsSL https://storage.googleapis.com/anthropic-release-public/claude-cli/install.sh | sh
    echo "✓ Claude Code installed"
else
    echo "✓ Claude Code already installed"
fi

# Setup Claude Code config symlinks
mkdir -p "$HOME/.claude"
if [ ! -L "$HOME/.claude/settings.json" ]; then
    ln -sf "$HOME/.dotfiles/claude/settings.json" "$HOME/.claude/settings.json"
    echo "✓ Linked Claude settings.json"
else
    echo "✓ Claude settings.json already linked"
fi
if [ ! -L "$HOME/.claude/commands" ]; then
    ln -sf "$HOME/.dotfiles/claude/commands" "$HOME/.claude/commands"
    echo "✓ Linked Claude commands"
else
    echo "✓ Claude commands already linked"
fi
if [ ! -L "$HOME/.claude/CLAUDE.md" ]; then
    ln -sf "$HOME/.dotfiles/claude/CLAUDE.md" "$HOME/.claude/CLAUDE.md"
    echo "✓ Linked Claude CLAUDE.md"
else
    echo "✓ Claude CLAUDE.md already linked"
fi
echo

# Setup Neovim with NvChad
if [ ! -d "$HOME/.config/nvim" ]; then
    echo "Setting up NvChad..."
    git clone https://github.com/NvChad/starter "$HOME/.config/nvim"
    
    # Run nvim to trigger lazy.nvim plugin installation, then run MasonInstallAll
    echo "Installing plugins and LSP servers..."
    nvim --headless "+Lazy! sync" +qa
    nvim --headless "+MasonInstallAll" +qa
    
    # Delete .git folder
    rm -rf "$HOME/.config/nvim/.git"
    echo "✓ NvChad setup complete"
else
    echo "✓ Neovim config already exists"
fi
echo

# Setup Oh My Zsh
if [ ! -d "$HOME/.dotfiles/zsh/.oh-my-zsh" ]; then
    echo "Installing Oh My Zsh..."
    
    # Create directory if it doesn't exist
    mkdir -p "$HOME/.dotfiles/zsh"
    
    # Download and run installer with custom directory
    export ZSH="$HOME/.dotfiles/zsh/.oh-my-zsh"
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc
    
    echo "✓ Oh My Zsh installed to $ZSH"
    echo "  Remember to update your .zshrc to use: export ZSH=\"$HOME/.dotfiles/zsh/.oh-my-zsh\""
else
    echo "✓ Oh My Zsh already installed"
fi
echo

# Setup Starship
if ! command -v starship &> /dev/null; then
    echo "Installing Starship..."
    curl -fsSL https://starship.rs/install.sh | sh
    echo "✓ Starship installed"
else
    echo "✓ Starship already installed"
fi
echo

# Setup uv
if ! command -v uv &> /dev/null; then
    echo "Installing uv..."
    curl -fsSL https://astral.sh/uv/install.sh | sh
    echo "✓ uv installed"
else
    echo "✓ uv already installed"
fi
echo

echo "=== Extras Complete ==="